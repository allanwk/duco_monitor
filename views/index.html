<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>
<body>
    <form>
        <label for="input_quantidade">Quantidade de leituras para carregar: </label>
        <input type="text" id="input_quantidade">
        <button onclick="update(event)" type="submit">Atualizar</button>
    </form>
</body>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    const randomNum = () => Math.floor(Math.random() * (235 - 52 + 1) + 52);
    const randomRGB = () => `rgb(${randomNum()}, ${randomNum()}, ${randomNum()})`;

    const variables = ['temperature', 'percentage', 'current', 'balance']
    let charts = {}
    for(let variable of variables){
        let data = {
            labels: [],
            datasets: [
                {
                    label: variable,
                    borderColor: randomRGB(),
                    data: []
                }
            ]
        }

        let canvas = document.createElement('canvas');
        document.body.appendChild(canvas);

        const config = {
            type: 'line',
            data: data,
            options: {}
        }

        charts[variable] = new Chart(
            canvas, 
            config
        )
    }

    async function update(event=null){
        if(event){
            event.preventDefault()
        }
        let number_readings = document.getElementById('input_quantidade').value
        let resp = await fetch('/api/' + number_readings)
           
        resp = await resp.json()
        
        for(let label of variables){
            charts[label].data.labels = Array.from(resp, (reading) => {
                let d = new Date(reading.datetime).toLocaleString()
                return d;
            }).reverse()
            if(label === 'balance'){
                let bal = Array.from(resp, reading => reading[label]).reverse()
                for (var i = bal.length - 1; i >= 1; i--) {
                    bal[i] -= bal[i - 1]
                }
                bal[0] = 0;
                charts[label].data.datasets.find(dataset => dataset.label === label).data = bal
            } else {
                charts[label].data.datasets.find(dataset => dataset.label === label).data = Array.from(resp, reading => reading[label]).reverse()
            }
            charts[label].update()
        }
    }
    update()
    setInterval(update, 60000)
</script>
</html>